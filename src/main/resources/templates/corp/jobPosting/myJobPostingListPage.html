<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ë¯¼ê¸°ì¸ë ¥ - ê¸°ì—… ë©”ì¸</title>
<th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
<link rel="stylesheet" th:href="@{/corp/mainCss/main_page.css}"/>
<link rel="stylesheet" th:href="@{/corp/jobPosting/myJobPostingListPage.css}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<style type="text/css">

</style>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', () => {
	
	//ê³µê³ ë“±ë¡ ë²„íŠ¼ í˜ì´ì§€ ì´ë™
	document.querySelector('#createPostingBtn').addEventListener('click', function() {
 		window.location.href = '/corp/jobPostingForm'; // í˜ì´ì§€ ì´ë™
	});
	
	//í—¤ë”ì— ìˆëŠ” ê°’ë“¤, SecurityContextì—ì„œ ê°€ì ¸ì™€ì„œ toStringí˜•íƒœì„  
	// JSON.parse(...) -> ë¬¸ìì—´ë¡œ ë˜ì–´ ìˆëŠ” JSON ë°ì´í„°ë¥¼ JavaScript ê°ì²´ë¡œ ë³€í™˜í•´ì£¼ëŠ” í•¨ìˆ˜ / ë°˜ëŒ€ë¡œ ìë°”ê°ì²´ë¥¼ JSONìœ¼ë¡œ -> JSON.stringify()
	let userEmail = document.querySelector('#userEmail').value;
	let userRole = document.querySelector('#userRole').value;
	let userCorpNo = document.querySelector('#userCorpNo').value;
	let userInfo = document.querySelector('#userInfo').dataset.user;

	//ë°ì´í„° ë¹„ë™ê¸° ê°€ì ¸ì˜¤ê¸° (ë§¤ê°œë³€ìˆ˜ ë„£ëŠ”ê±° ê¹Œë¨¹ì§€ë§ˆ) 
	fetchStartData(userCorpNo);

	//ì§„í–‰ì¤‘, ë§ˆê°, ì „ì²´ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ í´ë˜ìŠ¤ ì œê±° ë° ì¶”ê°€
	changeClassSelectedTotd(userCorpNo);
	
	//ì „ì²´, ë§ˆê°ì¼ìˆœ, ì¡°íšŒìˆ˜ìˆœ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ í´ë˜ìŠ¤ ì œê±° ë° ì¶”ê°€
	changeClassSubSelectedToInput(userCorpNo);
	
});//ready


//ì§€ì›ì ê´€ë¦¬ ëª¨ë‹¬ì°½
function openApplicantListModal(){
	alert('ì§€ì›ì ê´€ë¦¬ ëª¨ë‹¬ì°½ ì—´ë¦¼ ëŒ€ì‹ ì— í˜ì´ì§€ ì´ë™ìœ¼ë¡œ ì²˜ë¦¬, ì¶”í›„ ëª¨ë‹¬ì°½ìœ¼ë¡œ ê°„ëµ ì¡°íšŒ ê¸°ëŠ¥êµ¬í˜„í•  ê²ƒ ');
	location.href="/corp/applicant";
}

//ì²˜ìŒí™”ë©´ ìë£Œ ë¿Œë¦¬ê¸°(ì§„í–‰ì¤‘, ì „ì²´)
function fetchStartData(userCorpNo){
	var url =`/corp/getMyAllPosting?corpNo=${userCorpNo}&postSts=ing&orderBy=start`;
	fetch( url )
	.then(response => {
		if(!response){
			alert("ë°ì´í„° ê°–ê³ ì˜¤ê¸° ì‹¤íŒ¨");
			throw new Error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë˜ ì¤‘ì— ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
		}
		return response.json();
	})
	.then(data => {
		//ë°ì´í„°ê°€ ì¡´ì¬í•  ë–„
		if(data.length > 0){ 
			let resultData = document.querySelector('#resultData');
			
			console.log(data);
			
			
		} else {
			//ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ
			
		}
	})
}

//ì§„í–‰ì¤‘, ë§ˆê°, ì „ì²´ í´ë¦­ì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€ ê·¸ë¦¬ê³  ë¹„ë™ê¸°ë¡œ ì¡°íšŒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° 
function changeClassSelectedTotd(userCorpNo){
	//console.log(typeof userCorpNo); //String ì´ë¼ì„œ numberë¡œ ë°”ê¿”ì¤˜ì•¼ 
	let corpNo = Number(userCorpNo); 
	let orderBy = "start"; //ì •ë¥ ìˆœì€ ê³ ì • 
	let postSts = "";
	document.querySelectorAll('.posting-status').forEach(td => {
		//ì´ˆê¸°ê°’ ë™ê¸°ì ìœ¼ë¡œ ë¶€ì—¬ 
		/* if(td.classList.contains('selected')){
		}; */
		td.addEventListener('click', () => {
			//ê¸°ì¡´ì— ì„ íƒëœ tdì—ì„œ í´ë˜ìŠ¤ ì œê±° 
			document.querySelectorAll('.posting-status').forEach(item => {
				item.classList.remove('selected');
			});
			//ê·¸ëŸ¬ê³  ë‚˜ì„œ í´ë¦­ëœ tdì—ë§Œ í´ë˜ìŠ¤ ì¶”ê°€í• ê±° 
			td.classList.add('selected');
			
			//ë¹„ë™ê¸°ë¡œ í•´ë‹¹ ë²„íŠ¼ì— ë§ëŠ” ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°(ì§„í–‰ì¤‘ing, ë§ˆê°end, ì „ì²´total) & ì „ì²´(ê³µê³ ìµœì‹ ìˆœ)
			if(td.id == 'getIngPosting'){
				postSts = "ing";
			} else if (td.id == 'getEndPosting'){
				postSts = "end";
			} else if (td.id == 'getAllPosting'){
				postSts = "total";
			}
			//ìì‹ë²„íŠ¼ í´ë˜ìŠ¤ë¥¼ 'ì „ì²´'ìª½ìœ¼ë¡œ ì´ˆê¸°í™” í•´ì¤˜ 
			document.querySelectorAll('.posting-subStatus').forEach(item => {
				item.classList.remove('subSelected');
			});
			document.querySelector('.posting-subStatus').classList.add('subSelected'); //ë§¨ ì²˜ìŒìš”ì†Œ(ì „ì²´)ì— í´ë˜ìŠ¤ ë¶€ì—¬ 
			
			//alert('ì¢…ë¥˜ : ' + postSts + ', ì •ë ¬ìˆœì„œ : ' + orderBy);
			
			let url = `/corp/postings/selectby/${corpNo}/${postSts}/${orderBy}`;
			fetch(url, {
				method : 'GET',
			})
			.then(response => {
				if(!response){
					throw new Error('ì¡°íšŒ ìš”ì²­ ì‹¤íŒ¨');
				}
				return response.json(); //ë°‘ì—ì„œDOMë‹¤ì‹œ í•´ì•¼í•˜ë‹ˆê¹Œ JSONìœ¼ë¡œ, (.text() xxx)
			})
			.then(data => {
				console.log(data);
                updatePostingTable(data.postList);
                updatePostingCounts(data);
			})
			.catch(error => {
				
				console.error(error);
			})
		});
	});
}

//ì§„í–‰ì¤‘, ë§ˆê°, ì „ì²´ í´ë¦­ì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€ ê·¸ë¦¬ê³  ë¹„ë™ê¸°ë¡œ ì¡°íšŒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° 
function changeClassSubSelectedToInput(userCorpNo){
	let corpNo = userCorpNo;
	let postSts = "ing";
	let orderBy = "start"; //ì´ˆê¸°ê°’ 
	
	document.querySelectorAll('.posting-subStatus').forEach(sub => {
		
		sub.addEventListener('click', () => {
			document.querySelectorAll('.posting-subStatus').forEach(item => {
				item.classList.remove('subSelected');
			});
			sub.classList.add('subSelected');
			
			//ìƒìœ„ ë²„íŠ¼í´ë˜ìŠ¤ í™•ì¸ ë¨¼ì € 
			document.querySelectorAll('.posting-status').forEach(item => {
				if(item.classList.contains('selected')){
					if(item.id == 'getIngPosting'){
						postSts = "ing";
					} else if(item.id == 'getEndPosting'){
						postSts = "end";
					} else if(item.id == 'getAllPosting'){
						postSts = "total";
					}
				}
			});
			
			//í•˜ìœ„ë²„íŠ¼ ê°’ í™•ì¸
			if(sub.id == 'odbSd'){
				orderBy = "start";
			} else  if(sub.id == 'odbEd'){
				orderBy = "end";
			} else  if (sub.id == 'odbVc'){
				orderBy = "viewCnt";
			}
			
			//alert('ì¢…ë¥˜ : ' + postSts + ', ì •ë ¬ìˆœì„œ : ' + orderBy);
			
			//DOM ì¬êµ¬ì„± fetch ì „ì†¡ 
			let url = `/corp/postings/selectby/${corpNo}/${postSts}/${orderBy}`;
			fetch(url, {
				method : 'GET',
			})
			.then(response => {
				if(!response){
					throw new Error('ì¡°íšŒ ìš”ì²­ ì‹¤íŒ¨');
				}
				return response.json(); //ë°‘ì—ì„œDOMë‹¤ì‹œ í•´ì•¼í•˜ë‹ˆê¹Œ JSONìœ¼ë¡œ, (.text() xxx)
			})
			.then(data => {
				console.log(data);
                updatePostingTable(data.postList);
                updatePostingCounts(data);
			})
			.catch(error => {
				
				console.error(error);
			})
			
		});
	});
}

//ìƒë‹¨ì— ê³µê³  nê°œì”© ë³´ê¸° ì„¤ì •
function selectPostingByCnt(){
	alert('ë¯¸êµ¬í˜„');
}


//ìˆ˜ì • ë²„íŠ¼ í´ë¦­
function updatePosting(jobPostingSeq){
	if(confirm('jobPostingSeq : ' + jobPostingSeq + ', ê³µê³  ìˆ˜ì • ã„±?')){
		location.href=`/corp/postings/updateForm/${jobPostingSeq}`;
	}
}

//ë§ˆê° ë²„íŠ¼ í´ë¦­ (í•œë²ˆ RESTful API í˜¸ì¶œë°©ë²•ìœ¼ë¡œ í•´ë³¼ê¹Œ?)
function finishPosting(jobPostingSeq){
	if(confirm('í•´ë‹¹ ê³µê³ ë¥¼ ì¡°ê¸° ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
		let url = `/corp/postings/${jobPostingSeq}`;
		fetch(url, {
			method: 'DELETE',
		})
		.then(response => {
			if(!response.ok){
				throw new Error('ìš”ì²­ ì‹¤íŒ¨');
			} else {
				return response.text();
			}
		})
		.then(result => {
			alert(result);
			location.href="/corp/myJobPostingListPage";
		})
		.catch(error => {
			alert('ê³µê³  ì¡°ê¸°ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨');
			console.error(error);
		})
	}
	return false;
}

//ì§€ì›ì í†µê³„ ë²„íŠ¼ í´ë¦­
function getApplicantStats(jobPostingSeq){
	alert(jobPostingSeq +'-ê³µê³  ì§€ì›ì í†µê³„ : í˜„ì¬ ë¯¸êµ¬í˜„');
}

//ê³µê³  ìƒì„¸ë³´ê¸° (ìœ ì €í˜ì´ì§€ë¡œ ì´ë™)
function getDetailPostingInfo(jobPostingSeq){
	location.href=`/user/job_posting/job_posting_detail?jobPostingSeq=${jobPostingSeq}`;
}

//DOM ë¹„ë™ê¸° ì²˜ë¦¬(ì „ì²´, ì§„í–‰ì¤‘, ë§ˆê°)
function updatePostingTable(postList) {
    const tbody = document.querySelector('#resultData');
    tbody.innerHTML = ''; // ì´ˆê¸°í™” 
    
    if (!postList || postList.length === 0) {
        const trEmpty = document.createElement('tr');
        trEmpty.innerHTML = `<td colspan='5' style="text-align: center;">ì¡°íšŒ ëª©ë¡ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê³µê³ ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!</td>`;
        tbody.appendChild(trEmpty);
    } else {
	    postList.forEach(post => {
	        const tr = document.createElement('tr');
	        tr.innerHTML = `
	            <td class="posting-box-need-center">${post.isEnded == 'N' ? 'ì§„í–‰ ì¤‘' : 'ê³µê³  ë§ˆê°'}</td>
	            <td>
	                <a><span id="jobPosting-${post.jobPostingSeq}" class="detail-posting-link" onclick="getDetailPostingInfo(${post.jobPostingSeq})">${post.postingTitle}</span></a>
	                <ul>
	                    <li>ê·¼ë¬´í˜•íƒœ : <span>${post.employType}</span></li>
	                    <li>í¬ì§€ì…˜ : <span>${post.positionName}</span></li>
	                    <li>ê²½ë ¥ : <span>${post.expLevel}</span></li>
	                    <li>ì ‘ìˆ˜ê¸°ê°„ : <span>${post.postingStartDt}</span> ~ <span>${post.postingEndDt}</span></li>
	                    <li>ì¡°íšŒìˆ˜ : <span>${post.viewCnt} </span></li>
	                </ul>
	            </td>`;
	            let nOrY = '';
	            if(post.isEnded == 'N'){
	            	nOrY = `
		            <td class="posting-box-need-center">
		                <button type="button" onclick="updatePosting(${post.jobPostingSeq})">ìˆ˜ì •</button>
		                <button type="button" onclick="finishPosting(${post.jobPostingSeq})">ë§ˆê°</button>
		            </td>`;
	            }
	            if(post.isEnded == 'Y'){
	            	nOrY =`
					<td class="posting-box-need-center">
						<button type="button" style='background-color:grey;' disabled>ìˆ˜ì • </button>
						<button type="button" style='background-color:grey;' disabled>ë§ˆê° </button>
					</td>`;
	            }
	            tr.innerHTML += nOrY;
	            tr.innerHTML += `
	            <td class="posting-box-need-center">
	                <div><a style="cursor: pointer; text-decoration: underline;" onclick="openApplicantListModal()"><span>${post.appCnt}</span></a></div>
	                <div style="color: black; cursor: pointer;" onclick="openApplicantListModal()">ì§€ì›ì ê´€ë¦¬ <i class="bi bi-file-earmark-ruled"></i></div>
	                <div><input type="button" value="ì§€ì›ì í†µê³„" onclick="getApplicantStats(${post.jobPostingSeq})"></div>
	            </td>
	            <td class="posting-box-need-center">
	                <button type="button">í™•ì¸</button>
	            </td>
	        	`;
	        tbody.appendChild(tr);
	    });
   	}
}

//ê±´ìˆ˜ ì—…ë°ì´íŠ¸
function updatePostingCounts(data) {
    if (data.postCnt) {
        const counts = data.postCnt[0];

        const ingTh = document.querySelector('#getIngPosting');
        if (ingTh) ingTh.innerHTML = `ì§„í–‰ì¤‘ (<span>${counts.ING_POSTING_CNT || 0}</span>)ê±´`;

        const endTh = document.querySelector('#getEndPosting');
        if (endTh) endTh.innerHTML = `ë§ˆê° (<span>${counts.END_POSTING_CNT || 0}</span>)ê±´`;

        const totalTh = document.querySelector('#getAllPosting');
        if (totalTh) totalTh.innerHTML = `ì „ì²´ (<span>${counts.TOTAL_POSTING_CNT || 0}</span>)ê±´`;
    }
}

</script>
</head>
<body>
<th:block th:replace="~{fragments/corpHeader :: corpHeader}"></th:block>

<div class="corp-main-container">
	<div> <!-- ìƒë‹¨ -->
		<div class="corp-posting-status"> <!-- ìƒë‹¨ì˜ ê³µê³ ìƒíƒœì™€ ê±´ìˆ˜, ì˜¤ë¥¸ìª½ì— ì±„ìš©ê³µê³  ë“±ë¡ ë²„íŠ¼  -->
			<div> <!-- í…Œì´ë¸” -->
				<table class="table table-bordered"> 
					<tr>
						<th id="getIngPosting" class="posting-status selected">ì§„í–‰ì¤‘ (<span th:text="${postCntMapList[0].ING_POSTING_CNT ?: 0}"></span>)ê±´ </th>
						<th id="getEndPosting" class="posting-status">ë§ˆê° (<span th:text="${postCntMapList[0].END_POSTING_CNT ?: 0}"></span>)ê±´ </th>
						<th id="getAllPosting" class="posting-status">ì „ì²´ (<span th:text="${postCntMapList[0].TOTAL_POSTING_CNT ?: 0}"></span>)ê±´ </th>
					</tr>
				</table>
			</div>
			<div>
				<input id="createPostingBtn" class="create-job-posting-btn" type="button" value="ğŸ“‘ì±„ìš©ê³µê³  ë“±ë¡">
			</div>
		</div>
		<hr class="border border-primary border-2 opacity-50 status-bottom-hr">
		<div class="get-posting-orderby"> <!-- ìƒë‹¨ì˜ ì •ë ¬ ìˆœì„œ -->
			<div> 
				<!-- ì „ì²´ëŠ” ìµœì‹  ë“±ë¡ìˆœ -->
				<input type="button" class="posting-subStatus subSelected" value="ì „ì²´" id="odbSd" > |
				<input type="button" class="posting-subStatus" value="ë§ˆê°ì¼ìˆœ" id="odbEd" > |
				<input type="button" class="posting-subStatus" value="ì¡°íšŒìˆ˜ìˆœ" id="odbVc" >
			</div>
		</div>
	</div> <!-- ìƒë‹¨ ë -->
	<div class="bottom-start-container"> <!-- í•˜ë‹¨ ì‹œì‘ -->
		<div class="bottom-select-box"> <!-- í•˜ë‹¨ì— 'ì¼ë°˜ ì±„ìš©ê³µê³ ' ê¸€ì, ì •ë ¬ ê¸°ì¤€ ì…€ë ‰ì…˜ -->
			<div>
				<p>â¡ï¸ì¼ë°˜ ì±„ìš©ê³µê³ </p>
			</div>
			<div>
				<select id="selectCnt" th:onchange="selectPostingByCnt()">
					<option selected>5ê°œì”©ë³´ê¸°</option>
					<option>10ê°œì”©ë³´ê¸°</option>
					<option>20ê°œì”©ë³´ê¸°</option>
				</select>				
			</div>		
		</div>
		<div> <!-- ê³µê³  ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
			<table class="table">
				<thead class="table-light">
					<tr>
						<th>ê³µê³  ìƒíƒœ</th>
						<th>ëª¨ì§‘ ë‚´ìš©</th>
						<th>ê³µê³  ê´€ë¦¬</th>
						<th>ì§€ì›ì ê´€ë¦¬</th>
						<th style="color: #f53600">AIì¸ì¬ì¶”ì²œ</th>
					</tr>
				</thead>
				<tbody id="resultData" >
					<tr th:if="${#lists.isEmpty(postList) }">
						<td colspan="5" style="text-align: center;">ì¡°íšŒ ëª©ë¡ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê³µê³ ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”!</td>
					</tr>
				
					<tr th:each="post : ${postList}">
						<td class="posting-box-need-center" th:text="${post.isEnded == 'N' ? 'ì§„í–‰ ì¤‘' : 'ê³µê³  ë§ˆê°'}"></td>
						<td>
							<a><span id="jobPosting-${jobPostingSeq}"  class="detail-posting-link" th:text="${post.postingTitle}" th:onclick="'getDetailPostingInfo('+ ${post.jobPostingSeq} +')'"></span></a>
							<ul>
								<li>ê·¼ë¬´í˜•íƒœ : <span th:text="${post.employType}"></span> </li>
								<li>í¬ì§€ì…˜ : <span th:text="${post.positionName}"></span> </li>
								<li>ê²½ë ¥ : <span th:text="${post.expLevel}"></span> </li>
								<li>ì ‘ìˆ˜ê¸°ê°„ : <span th:text="${post.postingStartDt}"></span> ~ <span th:text="${post.postingEndDt}"></span> </li>
								<li>ì¡°íšŒìˆ˜ : <span th:text="${post.viewCnt}"></span></span> </li>
							</ul>
						</td>
						<td class="posting-box-need-center" th:if="${post.isEnded == 'N'}">
							<button type="button" th:onclick="'updatePosting(' + ${post.jobPostingSeq} + ')'">ìˆ˜ì • </button>
							<button type="button" th:onclick="'finishPosting(' + ${post.jobPostingSeq} + ')'">ë§ˆê° </button>
						</td>
						<td class="posting-box-need-center" th:if="${post.isEnded == 'Y'}">
							<button type="button" readonly>ìˆ˜ì • </button>
							<button type="button" readonly>ë§ˆê° </button>
						</td>
						<td class="posting-box-need-center">
							<div><a style="cursor: pointer; text-decoration: underline;" th:onclick="openApplicantListModal()"><span th:text="${post.appCnt}"></span> </a></div>
							<div style="color: black; cursor: pointer;" th:onclick="openApplicantListModal()"> ì§€ì›ì ê´€ë¦¬ <i class="bi bi-file-earmark-ruled"></i></div>
							<div> <input type="button" value="ì§€ì›ì í†µê³„" th:onclick="'getApplicantStats(' + ${post.jobPostingSeq} + ')'"> </div>
						</td>
						<td class="posting-box-need-center">
							<button type="button">í™•ì¸</button>
						</td>
					</tr>
					
				</tbody>
			</table>
		</div>
	</div> <!-- í•˜ë‹¨ ë -->
	
	<!-- ëª¨ë‹¬ì°½ : ì§€ì›ì ê´€ë¦¬ -->
	<div>
	
	</div>
	<!-- ëª¨ë‹¬ì°½ : ì§€ì›ì í†µê³„ -->
	
	
</div>
 
<th:block th:replace="~{fragments/corpFooter :: corpFooter}"></th:block>
</body>
</html>