<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë¯¼ê¸° ì¸ë ¥</title>
<th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
<link rel="stylesheet" th:href="@{/user/css/header.css}" />
<link rel="stylesheet" th:href="@{/user/css/footer.css}" />
<link rel="stylesheet" th:href="@{/user/jobPosting/css/main_page.css}"/>
<link rel="stylesheet" th:href="@{/user/jobPosting/css/job_posting_detail.css}"/>
<style type="text/css">
</style>     
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    const $modal = $('#applyModal');
    let selectedResumeId = null;

    // ëª¨ë‹¬ ì—´ê¸° - ë§ˆê°ì¼ ì²´í¬ ì¶”ê°€
    $('#applyBtn').on('click', function (e) {
        e.preventDefault();
        
        // ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ëª¨ë‹¬ì„ ì—´ì§€ ì•ŠìŒ
        if ($(this).hasClass('disabled') || $(this).prop('disabled')) {
            alert('ë§ˆê°ëœ ê³µê³ ì…ë‹ˆë‹¤.');
            return;
        }
        
        $modal.show().addClass('show');
        $('body').css('overflow', 'hidden'); // âœ… ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
        fetchUserResumes();
        fetchUserAttachments();
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        $modal.hide().removeClass('show');
        $('body').css('overflow', ''); // âœ… ìŠ¤í¬ë¡¤ ë³µì›
        selectedResumeId = null;
        $('.resume-item').removeClass('selected');
        $('#attachmentList').empty();
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
        $('input[name="selectedAttachments"]').prop('checked', false);
    }

    $('#closeBtn, #cancelBtn').on('click', function () {
        closeModal();
    });

    $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && $modal.hasClass('show')) {
            closeModal();
        }
    });

    // ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    function fetchUserResumes() {
        $.ajax({
            url: '/user/resume',
            method: 'GET',
            success: function (resumes) {
                renderResumeList(resumes);
            },
            error: function () {
                alert('ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
    
    function fetchUserAttachments(){
    	$.ajax({
    		url:'/user/attachments',
    		method:'GET',
    		success:function(attachments){
    			renderAttachmentList(attachments);
    		},
    		error: function () {
                console.error('ì²¨ë¶€íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                $('#attachmentList').html('<p>ì²¨ë¶€íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>');
            }
    	});
    }

    
    function fetchUserAttachments(){
        console.log('ì²¨ë¶€íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘'); // ë””ë²„ê¹… ë¡œê·¸
        
        $.ajax({
            url:'/user/attachments',
            method:'GET',
            success:function(attachments){
                console.log('ì²¨ë¶€íŒŒì¼ ì¡°íšŒ ì„±ê³µ:', attachments); // ì‘ë‹µ ë°ì´í„° í™•ì¸
                renderAttachmentList(attachments);
            },
            error: function (xhr, status, error) {
                console.error('ì²¨ë¶€íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                $('#attachmentList').html('<p style="color: red;">ì²¨ë¶€íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ' + error + '</p>');
            }
        });
    }

    // ì²¨ë¶€íŒŒì¼ ë Œë”ë§ í•¨ìˆ˜ (ë””ë²„ê¹… ì¶”ê°€)
    function renderAttachmentList(attachments) {
        console.log('ì²¨ë¶€íŒŒì¼ ë Œë”ë§ ì‹œì‘:', attachments); // ë””ë²„ê¹… ë¡œê·¸
        
        const $container = $('#attachmentList');
        $container.empty();

        if (!attachments || attachments.length === 0) {
            console.log('ì²¨ë¶€íŒŒì¼ì´ ì—†ìŒ'); // ë””ë²„ê¹… ë¡œê·¸
            $container.append('<p>ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        console.log('ì²¨ë¶€íŒŒì¼ ê°œìˆ˜:', attachments.length); // ë””ë²„ê¹… ë¡œê·¸

        attachments.forEach((attachment, index) => {
            console.log(`ì²¨ë¶€íŒŒì¼ ${index}:`, attachment); // ê° ì²¨ë¶€íŒŒì¼ ì •ë³´ í™•ì¸
            
            const attachmentItem = $(`
                <div class="attachment-item">
                    <input type="checkbox" 
                           id="attachment_${attachment.attachmentSeq}" 
                           name="selectedAttachments" 
                           value="${attachment.attachmentSeq}" 
                           class="attachment-checkbox">
                    <label for="attachment_${attachment.attachmentSeq}" class="attachment-label">
                        <div class="attachment-icon">ğŸ“</div>
                        <div class="attachment-info">
                            <div class="attachment-name">${attachment.originalName || 'íŒŒì¼ëª… ì—†ìŒ'}</div>
                            <div class="attachment-meta">
                                ${attachment.createdAt || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ'} ì—…ë¡œë“œ 
                                ${attachment.fileSize ? '(' + Math.round(attachment.fileSize / 1024) + 'KB)' : ''}
                            </div>
                        </div>
                    </label>
                </div>
            `);
            $container.append(attachmentItem);
        });
        
        console.log('ì²¨ë¶€íŒŒì¼ ë Œë”ë§ ì™„ë£Œ'); // ë””ë²„ê¹… ë¡œê·¸
    }
    
    
    function renderResumeList(resumes) {
        const $container = $('.resume-section');
        $container.empty();

        if (!resumes || resumes.length === 0) {
            $container.append('<p>ë“±ë¡ëœ ì´ë ¥ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        resumes.forEach((resume, index) => {
            const resumeId = resume.resumeSeq;

            const resumeItem = $(`
                <div class="resume-item">
                    <input type="radio" id="resume_${resumeId}" name="selectedResume" value="${resumeId}" class="resume-radio">
                    <label for="resume_${resumeId}" class="resume-label">
                        <div class="resume-icon"></div>
                        <div class="resume-info">
                            <div class="resume-title">${resume.title}</div>
                            <div class="resume-meta">${resume.createdAt || ''} ë“±ë¡</div>
                        </div>
                    </label>
                </div>
            `);

            resumeItem.find('input').on('change', function () {
                selectedResumeId = parseInt($(this).val(), 10);
                $('.resume-item').removeClass('selected');
                resumeItem.addClass('selected');
            });

            $container.append(resumeItem);
        });

        if (resumes.length > 0) {
            selectedResumeId = parseInt(resumes[0].resumeSeq, 10);
            $(`#resume_${selectedResumeId}`).prop('checked', true);
            $(`#resume_${selectedResumeId}`).closest('.resume-item').addClass('selected');
        }
    }


    // ì§€ì›í•˜ê¸° ë²„íŠ¼ í´ë¦­
    $('#confirmBtn').on('click', function () {
        if (!selectedResumeId) {
            alert('ì´ë ¥ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const jobPostingSeq = parseInt($('#jobPostingSeq').val(), 10);
        if (!jobPostingSeq) {
            alert('ì˜ëª»ëœ ê³µê³  ì •ë³´ì…ë‹ˆë‹¤.');
            return;
        }
		
        //ì„ íƒí•œ ì²¨ë¶€íŒŒì¼ë“¤
        const selectedAttachments = [];
        $('input[name="selectedAttachments"]:checked').each(function() {
            selectedAttachments.push(parseInt($(this).val(), 10));
        });


        const formData = {
            resumeSeq: selectedResumeId,
            jobPostingSeq: jobPostingSeq,
            selectedAttachments: selectedAttachments
        };


        $.ajax({
            url: '/apply',
            method: 'POST',
            data: formData,
            traditional: true, // ë°°ì—´ íŒŒë¼ë¯¸í„° ì „ì†¡ì„ ìœ„í•´ í•„ìš”
            success: function () {
                alert('ì§€ì› ì™„ë£Œ');
                closeModal();
            },
            error: function (xhr) {
                alert('ì§€ì› ì˜¤ë¥˜: ' + xhr.responseText);
            }
        });
    });
});

$(document).ready(function () {
    const jobPostingSeqStr = $("#jobPostingSeqForScrap").val();
    if (jobPostingSeqStr && !isNaN(jobPostingSeqStr)) {
        const jobPostingSeq = parseInt(jobPostingSeqStr, 10);

        // â­ [1] í˜ì´ì§€ ë¡œë”© ì‹œ ìŠ¤í¬ë© ìƒíƒœ ì²´í¬
        $.ajax({
            url: "/scrap/check",
            method: "GET",
            data: { jobPostingSeq: jobPostingSeq },
            success: function (data) {
                if (data.success) {
                    const heartIcon = $("#heartIcon");
                    heartIcon.text(data.scrapped ? "â¤ï¸" : "ğŸ¤");
                }
            },
            error: function () {
                console.error("ìŠ¤í¬ë© ìƒíƒœ í™•ì¸ ì‹¤íŒ¨");
            }
        });

        // â­ [2] ë²„íŠ¼ í´ë¦­ ì‹œ ìŠ¤í¬ë© ì¶”ê°€/ì‚­ì œ
        $("#scrapBtn").click(function () {
            const heartIcon = $("#heartIcon");
            const isScrapped = heartIcon.text() == "â¤ï¸";
            const url = isScrapped ? "/scrap/remove" : "/scrap/add";

            $.ajax({
                url: url,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ jobPostingSeq: jobPostingSeq }),
                success: function (data) {
                    alert(data.message);
                    if (data.success) {
                        heartIcon.text(isScrapped ? "ğŸ¤" : "â¤ï¸");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("ìŠ¤í¬ë© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                    alert("ìŠ¤í¬ë© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });
    } else {
        console.warn("ê³µê³  ë²ˆí˜¸ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
});

$(document).ready(function () {
    $("#shareBtn").click(function (e) {
        e.preventDefault(); // ë§í¬ ì´ë™ ë°©ì§€
        var url = window.location.href;
        var textarea = document.createElement("textarea");
        document.body.appendChild(textarea);
        textarea.value = url;
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        alert("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
});



</script>

</head>
<body>
<header>
<div th:replace="~{fragments/header :: header}"></div>
</header>
<main>
   <div class="main-container" style="display: flex; gap: 30px;">
<div style="flex: 1;">

            <br>
            <h2 class="job_posting_title" th:text="${jDto.postingTitle}" style="font-weight: bold;"></h2>
            
            <br>
            <div class="stack">
                <h3 class="section-title" style="font-size: 20px;">ê¸°ìˆ ìŠ¤íƒ</h3>
                <div class="tech-stack-container">
                       <span class="tech-stack-tag" th:text="${jDto != null} ? ${jDto.techNames} : ''"></span>
                </div>
            </div>

	           <div class="job-section">
				  <h2 style="font-size: 20px;">ì£¼ìš”ë‚´ìš©</h2>
				  <div class="content-detail" th:text="${jDto.postingDetail}"></div>
				</div>
            <div class="job-info-box">
                <div>
                    <h2 style="font-size: 20px;" >ê²½ë ¥</h2>
                  <p th:text="${jDto.expLevel}" style="font-size: 15px;">ê²½ë ¥</p>

                </div>
                <div>
                    <h2 style="font-size: 20px;">í•™ë ¥</h2>
                    <p th:text="${jDto.eduLevel}" style="font-size: 15px;">ë¬´ê´€</p>
                </div>
                <div>
                    <h2 style="font-size: 20px;">ë§ˆê°ì¼ </h2>
                    <p th:text="${jDto.postingEndDt}" style="font-size: 15px;">ë§ˆê°ì¼</p>

                </div>
                <div>
                    <h2 style="font-size: 20px;">ê·¼ë¬´ì§€</h2>
               	  <p th:text="|${jDto.roadAddress} ${jDto.detailAddress}|">ê·¼ë¬´ì£¼ì†Œ</p>
                </div>
                <div> 
                    <h2 style="font-size: 20px;">í‰ê·  ì—°ë´‰</h2>
                    <p style="font-size: 15px;" th:text="${corpAvgSal}"></p>
                </div>
                <div>
                  <h2 style="font-size: 20px;">ê·¼ë¬´í˜•íƒœ</h2>
				<div th:if="${jDto.employType != 'ê³„ì•½'}">
				    <p th:text="${jDto.employType} ?: 'ì •ë³´ ì—†ìŒ'" style="font-size: 15px;">ê·¼ë¬´í˜•íƒœ</p>
				</div> 
				<div th:if="${jDto.employType == 'ê³„ì•½'}">
				    <p style="font-size: 15px;">
				        ê³„ì•½ ê¸°ê°„: 
				        <span th:text="|${jDto.contStartDt} ~ ${jDto.contEndDt}|"></span>
				    </p>
				</div>

                </div>
            </div>

           <div class="company-intro">
    <h2><strong>|ê¸°ì—…ì†Œê°œ|</strong></h2><br><br>
    
    <div class="company-content">
        <img th:src="@{/images/corpimg/{img}(img=${jDto.corpImg})}" alt="ê¸°ì—… ì´ë¯¸ì§€"
     style="width: auto; height: 400px; object-fit: cover; border-radius: 12px;" />
        <br><br>
  		  <h2 th:text="${jDto.corpNm}" style="font-size: 25px;">ê¸°ì—…ì´ë¦„</h2><br>
        <div class="company-description" th:text="${jDto.corpInfo}"></div>
    </div>
</div>
        </div>
    </div>

    <!-- í”Œë¡œíŒ… ì‚¬ì´ë“œë°” -->
  <div class="floating-sidebar">
    <div class="company-floating-card">
        <div class="company-logo-section">
            <div class="logo-placeholder">
                 <img th:src="@{/images/corplogo/{img}(img=${jDto.corpLogo})}" alt="ë¡œê³ " style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
            </div>
            <div class="company-title">
                <h4 th:text="${jDto.corpNm}">ê¸°ì—…ì´ë¦„</h4>
              <a th:href="@{/user/job_posting/company_info(corpNo=${jDto.corpNo})}">
			  ê¸°ì—…ì •ë³´ ë³´ê¸° &gt;
			</a>
            </div>
        </div>

        <div class="company-info-section">
            <div class="info-item">
                <span class="label">ì„¤ë¦½ì¼</span>
		<!-- <span class="value" id="corpCreatedAt"
		      th:text="${jDto.corpCreatedAt != null ? jDto.corpCreatedAt.substring(0,4) + '-' + jDto.corpCreatedAt.substring(4,6) + '-' + jDto.corpCreatedAt.substring(6,8) : 'ì •ë³´ ì—†ìŒ'}">
		</span> -->
		<span class="value" id="corpCreatedAt"
		      th:text="${jDto.corpCreatedAt}">
		</span>
                
            </div>
             <div class="info-item">
                <span class="label">í™ˆí˜ì´ì§€</span>
               <a th:href="${jDto.corpUrl}" target="_blank" class="go-link">ë°”ë¡œê°€ê¸°</a>
            </div>
        </div>

		<!-- ë¹„íšŒì› -->
       <div sec:authorize="!hasRole('ROLE_USER') and !hasRole('ROLE_CORP')">
          <a th:href="@{/login}" class="floating-apply-btn">ì§€ì›í•˜ê¸°</a>
       </div>
       
		<!-- íšŒì› -->
      <div sec:authorize="hasRole('ROLE_USER')">
        <div th:if="${user != null and user.corpNo == null}">
      
       <button class="floating-apply-btn" 
        id="applyBtn" 
        th:disabled="${jDto.isEnded == 'Y'}" 
        th:text="${jDto.isEnded == 'Y' ? 'ë§ˆê°ëœ ê³µê³ ' : 'ì§€ì›í•˜ê¸°'}"
        th:classappend="${jDto.isEnded == 'Y' ? ' disabled' : ''}">
		    ì§€ì›í•˜ê¸°
		</button>
		</div>
       </div>
	    <div class="floating-actions">
                <input type="hidden" id="jobPostingSeqForScrap" th:value="${jDto.jobPostingSeq}"/>
                
                <button class="floating-action-btn" id="scrapBtn">
                    <span class="icon" id="heartIcon">ğŸ¤</span>
                    <span class="text">ìŠ¤í¬ë©</span>
                </button>
                
                <button class="floating-action-btn" id="shareBtn">
                    <span class="icon">
                        <a href="#" onclick="clip(); return false;">ğŸ“ƒ</a>
                    </span>
                    <span class="text">ê³µìœ </span>
                </button>
            </div>
        </div>
    </div>

<!-- ëª¨ë‹¬ì°½ -->
 <div id="applyModal" class="modal">
        <div class="modal-content">
        <input type="hidden" id="jobPostingSeq" th:value="${jDto.jobPostingSeq}" />
            <div class="modal-header">
                <h2>ì…ì‚¬ì§€ì›</h2>
                <span class="close-btn" id="closeBtn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="job-info">
                   <div class="job-info">
				    <div class="job-title" th:text="${jDto.postingTitle}">ê³µê³  ì œëª©</div>
				    <div class="job-company" th:text="${jDto.corpNm}">íšŒì‚¬ëª…</div>
                </div>

                <div class="section-title">í†µí•© ê³„ì •ì •ë³´</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">ì´ë¦„</span>
                        <span class="info-value" th:text="${user != null ? user.name : 'ê²ŒìŠ¤íŠ¸'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì´ë©”ì¼</span>
                        <span class="info-value" th:text="${user != null ? user.email : 'ê²ŒìŠ¤íŠ¸'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì—°ë½ì²˜</span>
                        <span class="info-value" th:text="${user != null ? user.phone : 'ê²ŒìŠ¤íŠ¸'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì¶œìƒë…„ë„</span>
                        <span class="info-value" th:text="${user != null && user.birth != null ? user.birth : 'ì •ë³´ ì—†ìŒ'}"></span>
                    </div>
                </div>

                <div class="section-title">ì§€ì› ì´ë ¥ì„œ <span class="required">â—</span></div>
                <div class="resume-section">
                    <th:block th:each="resume, stat : ${resumes}">
                    <div class="resume-item">
                        <input type="radio"   th:id="'resume' + ${stat.index}" name="selectedResume" th:value="${resume.resumeSeq}" class="resume-radio" th:checked="${stat.index == 0}">
                        <label  th:for="'resume' + ${stat.index}" class="resume-label">
                            <div class="resume-icon"></div>
                            <div class="resume-info">
                                <div class="resume-title"  th:text="${resume.title}"></div>
                                <div class="resume-meta" th:text="|${resume.createdAt} ë“±ë¡|"></div>
                            </div>
                        </label>
                    </div>
                    </th:block>
                </div>
					
			<!-- ì²¨ë¶€íŒŒì¼ -->
			<div class="section-title">ì¶”ê°€ ì²¨ë¶€íŒŒì¼ (ì„ íƒì‚¬í•­)</div>
			    <div class="attachment-section">
			        <p class="attachment-description">ì§€ì›ì„œì™€ í•¨ê»˜ ì œì¶œí•  ì¶”ê°€ ì²¨ë¶€íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
			        <div id="attachmentList">
			            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
			        </div>
			    </div>
			</div>
										



            </div>
            <div class="modal-buttons">
                <button class="modal-cancel-btn" id="cancelBtn">ì·¨ì†Œ</button>
                <button class="modal-apply-btn" id="confirmBtn">ì§€ì›í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>
</main>
<footer>
<div th:replace="~{fragments/footer :: footer}"></div>
</footer>
</body>
</html>
