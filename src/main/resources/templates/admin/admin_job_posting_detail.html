<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë¯¼ê¸° ì¸ë ¥</title>
<th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
<link rel="stylesheet" th:href="@{/admin/css/admin_jobposting_detail.css}"/>
<style type="text/css">
.list-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
}

.list-btn:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

.list-btn:active {
    transform: translateY(0);
}
</style>     
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    const $modal = $('#applyModal');
    let selectedResumeId = null;

    // ëª©ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('#listBtn').on('click', function() {
        window.history.back(); // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
        // ë˜ëŠ” íŠ¹ì • ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™í•˜ë ¤ë©´: window.location.href = '/job-list';
    });

    // ëª¨ë‹¬ ì—´ê¸°
    $('#applyBtn').on('click', function (e) {
        e.preventDefault();
        
        if ($(this).hasClass('disabled') || $(this).prop('disabled')) {
            alert('ë§ˆê°ëœ ê³µê³ ì…ë‹ˆë‹¤.');
            return;
        }
        
        $modal.show().addClass('show');
        fetchUserResumes();
        fetchUserAttachments();
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        $modal.hide().removeClass('show');
        selectedResumeId = null;
        $('.resume-item').removeClass('selected');
        $('#attachmentList').empty();
        $('input[name="selectedAttachments"]').prop('checked', false);
    }

    $('#closeBtn, #cancelBtn').on('click', function () {
        closeModal();
    });

    $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && $modal.hasClass('show')) {
            closeModal();
        }
    });

    // ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    function fetchUserResumes() {
        $.ajax({
            url: '/user/resume',
            method: 'GET',
            success: function (resumes) {
                renderResumeList(resumes);
            },
            error: function () {
                alert('ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
    
    // ì²¨ë¶€íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    function fetchUserAttachments(){
        $.ajax({
            url:'/user/attachments',
            method:'GET',
            success:function(attachments){
                renderAttachmentList(attachments);
            },
            error: function () {
                console.error('ì²¨ë¶€íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                $('#attachmentList').html('<p>ì²¨ë¶€íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>');
            }
        });
    }

    // ì²¨ë¶€íŒŒì¼ ë Œë”ë§
    function renderAttachmentList(attachments) {
        const $container = $('#attachmentList');
        $container.empty();

        if (!attachments || attachments.length === 0) {
            $container.append('<p>ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        attachments.forEach((attachment) => {
            const attachmentItem = $(`
                <div class="attachment-item">
                    <input type="checkbox" 
                           id="attachment_${attachment.attachmentSeq}" 
                           name="selectedAttachments" 
                           value="${attachment.attachmentSeq}" 
                           class="attachment-checkbox">
                    <label for="attachment_${attachment.attachmentSeq}" class="attachment-label">
                        <div class="attachment-icon">ğŸ“</div>
                        <div class="attachment-info">
                            <div class="attachment-name">${attachment.originalName || 'íŒŒì¼ëª… ì—†ìŒ'}</div>
                            <div class="attachment-meta">
                                ${attachment.createdAt || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ'} ì—…ë¡œë“œ 
                                ${attachment.fileSize ? '(' + Math.round(attachment.fileSize / 1024) + 'KB)' : ''}
                            </div>
                        </div>
                    </label>
                </div>
            `);
            $container.append(attachmentItem);
        });
    }
    
    // ì´ë ¥ì„œ ë Œë”ë§
    function renderResumeList(resumes) {
        const $container = $('.resume-section');
        $container.empty();

        if (!resumes || resumes.length === 0) {
            $container.append('<p>ë“±ë¡ëœ ì´ë ¥ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        resumes.forEach((resume, index) => {
            const resumeId = resume.resumeSeq;

            const resumeItem = $(`
                <div class="resume-item">
                    <input type="radio" id="resume_${resumeId}" name="selectedResume" value="${resumeId}" class="resume-radio">
                    <label for="resume_${resumeId}" class="resume-label">
                        <div class="resume-icon"></div>
                        <div class="resume-info">
                            <div class="resume-title">${resume.title}</div>
                            <div class="resume-meta">${resume.createdAt || ''} ë“±ë¡</div>
                        </div>
                    </label>
                </div>
            `);

            resumeItem.find('input').on('change', function () {
                selectedResumeId = parseInt($(this).val(), 10);
                $('.resume-item').removeClass('selected');
                resumeItem.addClass('selected');
            });

            $container.append(resumeItem);
        });

        if (resumes.length > 0) {
            selectedResumeId = parseInt(resumes[0].resumeSeq, 10);
            $(`#resume_${selectedResumeId}`).prop('checked', true);
            $(`#resume_${selectedResumeId}`).closest('.resume-item').addClass('selected');
        }
    }

    // ì§€ì›í•˜ê¸° ë²„íŠ¼ í´ë¦­
    $('#confirmBtn').on('click', function () {
        if (!selectedResumeId) {
            alert('ì´ë ¥ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const jobPostingSeq = parseInt($('#jobPostingSeq').val(), 10);
        if (!jobPostingSeq) {
            alert('ì˜ëª»ëœ ê³µê³  ì •ë³´ì…ë‹ˆë‹¤.');
            return;
        }

        const selectedAttachments = [];
        $('input[name="selectedAttachments"]:checked').each(function() {
            selectedAttachments.push(parseInt($(this).val(), 10));
        });

        const formData = {
            resumeSeq: selectedResumeId,
            jobPostingSeq: jobPostingSeq,
            selectedAttachments: selectedAttachments
        };

        $.ajax({
            url: '/apply',
            method: 'POST',
            data: formData,
            traditional: true,
            success: function () {
                alert('ì§€ì› ì™„ë£Œ');
                closeModal();
            },
            error: function (xhr) {
                alert('ì§€ì› ì˜¤ë¥˜: ' + xhr.responseText);
            }
        });
    });

    // ìŠ¤í¬ë© ê¸°ëŠ¥
    const jobPostingSeqStr = $("#jobPostingSeqForScrap").val();
    if (jobPostingSeqStr && !isNaN(jobPostingSeqStr)) {
        const jobPostingSeq = parseInt(jobPostingSeqStr, 10);

        // í˜ì´ì§€ ë¡œë”© ì‹œ ìŠ¤í¬ë© ìƒíƒœ ì²´í¬
        $.ajax({
            url: "/scrap/check",
            method: "GET",
            data: { jobPostingSeq: jobPostingSeq },
            success: function (data) {
                if (data.success) {
                    const heartIcon = $("#heartIcon");
                    heartIcon.text(data.scrapped ? "â¤ï¸" : "ğŸ¤");
                }
            },
            error: function () {
                console.error("ìŠ¤í¬ë© ìƒíƒœ í™•ì¸ ì‹¤íŒ¨");
            }
        });

        // ìŠ¤í¬ë© ë²„íŠ¼ í´ë¦­
        $("#scrapBtn").click(function () {
            const heartIcon = $("#heartIcon");
            const isScrapped = heartIcon.text() == "â¤ï¸";
            const url = isScrapped ? "/scrap/remove" : "/scrap/add";

            $.ajax({
                url: url,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ jobPostingSeq: jobPostingSeq }),
                success: function (data) {
                    alert(data.message);
                    if (data.success) {
                        heartIcon.text(isScrapped ? "ğŸ¤" : "â¤ï¸");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("ìŠ¤í¬ë© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                    alert("ìŠ¤í¬ë© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });
    }

    // URL ê³µìœ  ê¸°ëŠ¥
    $("#shareBtn").click(function (e) {
        e.preventDefault();
        var url = window.location.href;
        var textarea = document.createElement("textarea");
        document.body.appendChild(textarea);
        textarea.value = url;
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        alert("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
});
</script>
</head>
<body>
<header>
</header>

<!-- ëª©ë¡ ë²„íŠ¼ -->
<button class="list-btn" id="listBtn">â† ëª©ë¡</button>

<main>
   <div class="main-container" style="display: flex; gap: 30px;">
        <div style="flex: 1;">
            <br>
            <h2 class="job_posting_title" th:text="${jDto.postingTitle}" style="font-weight: bold;"></h2>
            
            <br>
            <div class="stack">
                <h3 class="section-title" style="font-size: 20px;">ê¸°ìˆ ìŠ¤íƒ</h3>
                <div class="tech-stack-container">
                       <span class="tech-stack-tag" th:text="${jDto != null} ? ${jDto.techNames} : ''"></span>
                </div>
            </div>

            <div class="job-section">
               <h2 style="font-size: 20px;">ì£¼ìš”ë‚´ìš©</h2>
               <div class="content-detail" th:text="${jDto.postingDetail}"></div>
            </div>

            <div class="job-info-box">
                <div>
                    <h2 style="font-size: 20px;">ê²½ë ¥</h2>
                    <p th:text="${jDto.expLevel}" style="font-size: 15px;">ê²½ë ¥</p>
                </div>
                <div>
                    <h2 style="font-size: 20px;">í•™ë ¥</h2>
                    <p th:text="${jDto.eduLevel}" style="font-size: 15px;">ë¬´ê´€</p>
                </div>
                <div>
                    <h2 style="font-size: 20px;">ë§ˆê°ì¼</h2>
                    <p th:text="${jDto.postingEndDt}" style="font-size: 15px;">ë§ˆê°ì¼</p>
                </div>
                <div>
                    <h2 style="font-size: 20px;">ê·¼ë¬´ì§€</h2>
               	    <p th:text="|${jDto.roadAddress} ${jDto.detailAddress}|">ê·¼ë¬´ì£¼ì†Œ</p>
                </div>
                <div> 
                    <h2 style="font-size: 20px;">í‰ê·  ì—°ë´‰</h2>
                    <p style="font-size: 15px;" th:text="|${jDto.corpAvgSal}ë§Œì›| ?: 'íšŒì‚¬ë‚´ê·œì— ë”°ë¦„'"></p>
                </div>
                <div>
                    <h2 style="font-size: 20px;">ê·¼ë¬´í˜•íƒœ</h2>
                    <div th:if="${jDto.employType != 'ê³„ì•½'}">
                        <p th:text="${jDto.employType} ?: 'ì •ë³´ ì—†ìŒ'" style="font-size: 15px;">ê·¼ë¬´í˜•íƒœ</p>
                    </div> 
                    <div th:if="${jDto.employType == 'ê³„ì•½'}">
                        <p style="font-size: 15px;">
                            ê³„ì•½ ê¸°ê°„: 
                            <span th:text="|${jDto.contStartDt} ~ ${jDto.contEndDt}|"></span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="company-intro">
                <h2><strong>ê¸°ì—…ì†Œê°œ</strong></h2><br><br>
                
                <div class="company-content">
                    <img th:src="@{/images/corpimg/{img}(img=${jDto.corpImg})}" alt="ê¸°ì—… ì´ë¯¸ì§€"
                         style="width: auto; height: 400px; object-fit: cover; border-radius: 12px;" />
                    <br><br>
                    <h2 th:text="${jDto.corpNm}" style="font-size: 25px;">ê¸°ì—…ì´ë¦„</h2><br>
                    <div class="company-description" th:text="${jDto.corpInfo}"></div>
                </div>
            </div>
        </div>
    </div>


</main>
</body>
</html>