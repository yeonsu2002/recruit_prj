<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë¯¼ê¸° ì¸ë ¥</title>
<th:block th:replace="~{fragments/external_file :: cdn_block}"></th:block>
<link rel="stylesheet" th:href="@{/user/css/header.css}" />
<link rel="stylesheet" th:href="@{/user/css/footer.css}" />
<link rel="stylesheet" th:href="@{/user/jobPosting/css/main_page.css}"/>
<link rel="stylesheet" th:href="@{/user/jobPosting/css/job_posting_detail.css}"/>
<style type="text/css">
</style>     
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    const $modal = $('#applyModal');
    let selectedResumeId = null;

    // ëª¨ë‹¬ ì—´ê¸°
    $('#applyBtn').on('click', function (e) {
        e.preventDefault();
        $modal.show().addClass('show');
        fetchUserResumes();
        $('#attachmentList').empty(); // ì²¨ë¶€íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        $modal.hide().removeClass('show');
        selectedResumeId = null;
        $('.resume-item').removeClass('selected');
        $('#attachmentList').empty();
    }

    $('#closeBtn, #cancelBtn').on('click', function () {
        closeModal();
    });

    $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && $modal.hasClass('show')) {
            closeModal();
        }
    });

    // ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    function fetchUserResumes() {
        $.ajax({
            url: '/user/resume',
            method: 'GET',
            success: function (resumes) {
                renderResumeList(resumes);
            },
            error: function () {
                alert('ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    function renderResumeList(resumes) {
        const $container = $('.resume-section');
        $container.empty();

        if (!resumes || resumes.length === 0) {
            $container.append('<p>ë“±ë¡ëœ ì´ë ¥ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        resumes.forEach((resume, index) => {
            const resumeId = resume.resumeSeq;

            const resumeItem = $(`
                <div class="resume-item">
                    <input type="radio" id="resume_${resumeId}" name="selectedResume" value="${resumeId}" class="resume-radio">
                    <label for="resume_${resumeId}" class="resume-label">
                        <div class="resume-icon"></div>
                        <div class="resume-info">
                            <div class="resume-title">${resume.title}</div>
                            <div class="resume-meta">${resume.createdAt || ''} ë“±ë¡</div>
                        </div>
                    </label>
                </div>
            `);

            resumeItem.find('input').on('change', function () {
                selectedResumeId = parseInt($(this).val(), 10);
                $('.resume-item').removeClass('selected');
                resumeItem.addClass('selected');
                renderAttachmentList(resume.attachments || []);
            });

            $container.append(resumeItem);
        });

        if (resumes.length > 0) {
            selectedResumeId = parseInt(resumes[0].resumeSeq, 10);
            $(`#resume_${selectedResumeId}`).prop('checked', true);
            $(`#resume_${selectedResumeId}`).closest('.resume-item').addClass('selected');
            renderAttachmentList(resumes[0].attachments || []);
        }
    }

    function renderAttachmentList(attachments) {
        const $attachmentContainer = $('#attachmentList');
        $attachmentContainer.empty();

        if (!attachments || attachments.length === 0) {
            $attachmentContainer.append('<p>ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
            return;
        }

        attachments.forEach(att => {
            const attItem = $(`
                <div class="attachment-item">
                    <a href="/attachment/download/${att.id}" target="_blank">${att.fileName}</a>
                </div>
            `);
            $attachmentContainer.append(attItem);
        });
    }

    // ì§€ì›í•˜ê¸° ë²„íŠ¼ í´ë¦­
    $('#confirmBtn').on('click', function () {
        if (!selectedResumeId) {
            alert('ì´ë ¥ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const jobPostingSeq = parseInt($('#jobPostingSeq').val(), 10);
        if (!jobPostingSeq) {
            alert('ì˜ëª»ëœ ê³µê³  ì •ë³´ì…ë‹ˆë‹¤.');
            return;
        }

        $.ajax({
            url: '/apply',
            method: 'POST',
            data: {
                resumeSeq: selectedResumeId,
                jobPostingSeq: jobPostingSeq
            },
            success: function () {
                alert('ì§€ì› ì™„ë£Œ');
                closeModal();
            },
            error: function (xhr) {
                alert('ì§€ì› ì˜¤ë¥˜: ' + xhr.responseText);
            }
        });
    });
});

</script>

</head>
<body>
<header>
<div th:replace="~{fragments/header :: header}"></div>
</header>
<main>
     <div class="main-container" style="display: flex; gap: 30px;">
<div style="flex: 1;">

            <br>
            <h2 class="job_posting_title" th:text="${jDto.postingTitle}" style="font-weight: bold;"></h2>
            
            <br>
            <div class="stack">
                <h2 class="section-title" th:each="stack : ${jDto.techStacks}" th:text="${stack}">ê¸°ìˆ ìŠ¤íƒ</h2>
            
            </div>

            <div class="job-section">
               <h2>ì£¼ìš”ë‚´ìš©</h2>
               <p th:text="${jDto.postingDetail}"></p>
            
            </div>

            <div class="job-info-box">
                <div>
                    <h2>ê²½ë ¥</h2>
                  <p th:text="${jDto.expLevel}">ê²½ë ¥</p>

                </div>
                <div>
                    <h2>í•™ë ¥</h2>
                    <p>ë¬´ê´€</p>
                </div>
                <div>
                    <h2>ë§ˆê°ì¼</h2>
                    <p th:text="${jDto.postingEndDt}">ë§ˆê°ì¼</p>

                </div>
                <div>
                    <h2>ê·¼ë¬´ì§€</h2>
                   <p th:text="${jDto.roadAddress}">ê·¼ë¬´ì£¼ì†Œ</p>

                </div>
                <div>
                    <h2>í‰ê·  ì—°ë´‰</h2>
                    <p>3,000~4,500ë§Œì›</p>
                </div>
                <div>
                    <h2>ê·¼ë¬´í˜•íƒœ</h2>
                    <p th:text="${jDto.employType}">ê·¼ë¬´í˜•íƒœ</p>
                </div>
            </div>

            <div class="company-intro">
                <h2 style="font-size: 30px; margin-bottom: 20px;"  th:utext="${jDto.corpInfo}"><strong>ê¸°ì—…ì†Œê°œ</strong></h2>
                <img src="" class="company-image" />
                <div class="company-description">
                    ì €í¬ í…Œí¬ë…¸ë² ì´ì…˜ì€ í˜ì‹ ì ì¸ ê¸°ìˆ ê³¼ ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¡œ ë””ì§€í„¸ í˜ì‹ ì„ ì´ëŒì–´ê°€ëŠ” IT ê¸°ì—…ì…ë‹ˆë‹¤. 
                    2021ë…„ ì„¤ë¦½ ì´í›„ ì§€ì†ì ì¸ ì„±ì¥ì„ ì´ì–´ê°€ê³  ìˆìœ¼ë©°, ê³ ê°ì˜ ë‹ˆì¦ˆë¥¼ ì •í™•íˆ íŒŒì•…í•˜ê³  ìµœì ì˜ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ê¸° ìœ„í•´ ëŠì„ì—†ì´ ë…¸ë ¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    <br><br>
                    ì§ì›ë“¤ì˜ ì„±ì¥ê³¼ ë°œì „ì„ ìœ„í•œ ë‹¤ì–‘í•œ í”„ë¡œê·¸ë¨ì„ ìš´ì˜í•˜ë©°, ììœ ë¡­ê³  ìˆ˜í‰ì ì¸ ì¡°ì§ë¬¸í™”ë¥¼ ì¶”êµ¬í•©ë‹ˆë‹¤. 
                    ê°œë°œìë“¤ì´ ìµœê³ ì˜ í¼í¬ë¨¼ìŠ¤ë¥¼ ë°œíœ˜í•  ìˆ˜ ìˆë„ë¡ ìµœì‹  ê°œë°œ í™˜ê²½ê³¼ ë„êµ¬ë¥¼ ì œê³µí•˜ê³  ìˆìœ¼ë©°, 
                    ì§€ì†ì ì¸ í•™ìŠµê³¼ ì„±ì¥ì„ ì§€ì›í•˜ëŠ” êµìœ¡ í”„ë¡œê·¸ë¨ë„ ìš´ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    <br><br>
                    í•¨ê»˜ ì„±ì¥í•˜ë©° ë” ë‚˜ì€ ë¯¸ë˜ë¥¼ ë§Œë“¤ì–´ê°ˆ ë™ë£Œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- í”Œë¡œíŒ… ì‚¬ì´ë“œë°” -->
    <div class="floating-sidebar">
        <div class="company-floating-card">
            <div class="company-logo-section">
                <div class="logo-placeholder">
                    <span>ğŸ¢</span>
                </div>
                <div class="company-title">
                    <h4 th:text="${jDto.corpNm}">ê¸°ì—…ì´ë¦„</h4>
                    <span><a th:href="@{/user/job_posting/company_info}">ê¸°ì—…ì •ë³´ ë³´ê¸° &gt;</a></span>
                </div>
            </div>

            <div class="company-info-section">
                <div class="info-item">
                    <span class="label">ì—…ë ¥</span>
                    <span class="value">5ë…„ì°¨ (2021ë…„ ì„¤ë¦½)</span>
                </div>
            </div>

            <button class="floating-apply-btn" id="applyBtn">ì§€ì›í•˜ê¸°</button>

            <div class="floating-actions">
                <button class="floating-action-btn" id="scrapBtn">
                    <span class="icon" id="heartIcon">ğŸ¤</span>
                    <span class="text">ìŠ¤í¬ë©</span>
                </button>
            </div>
        </div>
    </div>

<!-- ëª¨ë‹¬ì°½ -->
 <div id="applyModal" class="modal">
        <div class="modal-content">
        <input type="hidden" id="jobPostingSeq" th:value="${jDto.jobPostingSeq}" />
            <div class="modal-header">
                <h2>ì…ì‚¬ì§€ì›</h2>
                <span class="close-btn" id="closeBtn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="job-info">
                   <div class="job-info">
				    <div class="job-title" th:text="${jDto.postingTitle}">ê³µê³  ì œëª©</div>
				    <div class="job-company" th:text="${jDto.corpNm}">íšŒì‚¬ëª…</div>
                </div>

                <div class="section-title">í†µí•© ê³„ì •ì •ë³´</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">ì´ë¦„</span>
                        <span class="info-value" th:text="${user != null ? user.name : 'ê²ŒìŠ¤íŠ¸'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì´ë©”ì¼</span>
                        <span class="info-value" th:text="${user != null ? user.email : 'ê²ŒìŠ¤íŠ¸'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì—°ë½ì²˜</span>
                        <span class="info-value" th:text="${user != null ? user.phone : 'ê²ŒìŠ¤íŠ¸'}"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ì¶œìƒë…„ë„</span>
                        <span class="info-value" th:text="${user != null && user.birth != null ? user.birth : 'ì •ë³´ ì—†ìŒ'}"></span>
                    </div>
                </div>

                <div class="section-title">ì§€ì› ì´ë ¥ì„œ <span class="required">â—</span></div>
                <div class="resume-section">
                    <th:block th:each="resume, stat : ${resumes}">
                    <div class="resume-item">
                        <input type="radio"   th:id="'resume' + ${stat.index}" name="selectedResume" th:value="${resume.resumeSeq}" class="resume-radio" th:checked="${stat.index == 0}">
                        <label  th:for="'resume' + ${stat.index}" class="resume-label">
                            <div class="resume-icon"></div>
                            <div class="resume-info">
                                <div class="resume-title"  th:text="${resume.title}"></div>
                                <div class="resume-meta" th:text="|${resume.createdAt} ë“±ë¡|"></div>
                            </div>
                        </label>
                    </div>
                    </th:block>
                </div>

               <div class="section-title">ì²¨ë¶€ íŒŒì¼</div>
				<div id="attachmentList" class="attachment-list"></div>
           
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel-btn" id="cancelBtn">ì·¨ì†Œ</button>
                <button class="modal-apply-btn" id="confirmBtn">ì§€ì›í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>
</main>
<footer>
<div th:replace="~{fragments/footer :: footer}"></div>
</footer>
</body>
</html>
